@model QLBanSach.Models.DonHang
@{
    ViewData["Title"] = "Chi Tiết Đơn Hàng";
}

<h2 class="mb-4 fw-bold text-primary text-center">
    Chi Tiết Đơn Hàng: @Model?.MaDonHang
</h2>

<!-- Hiển thị thông báo -->
@if (TempData["Message"] != null)
{
    var type = TempData["MessageType"]?.ToString() ?? "info";
    <div class="alert alert-@type alert-dismissible fade show shadow-sm" role="alert">
        @TempData["Message"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Card thông tin đơn hàng -->
<div class="card shadow-sm border-0 mb-4" style="border-radius:14px;">
    <div class="card-body">

        <h5 class="fw-bold text-primary mb-3">Thông tin đơn hàng</h5>

        <div class="row mb-2">
            <div class="col-4 fw-semibold">Địa chỉ nhận hàng:</div>
            <div class="col-8">@Model?.DiaChiNhanHang</div>
        </div>

        <div class="row mb-2">
            <div class="col-4 fw-semibold">Ngày đặt:</div>
            <div class="col-8">@Model?.NgayDat.ToString("dd/MM/yyyy HH:mm")</div>
        </div>

        <div class="row mb-2 align-items-center">
            <div class="col-4 fw-semibold">Trạng thái:</div>
            <div class="col-8">

                <span class="badge px-3 py-2
                    @(Model.TrangThai == "Đã hủy" ? "bg-danger" :
                                            Model.TrangThai == "Đã nhận hàng" ? "bg-success" : "bg-primary")">
                    @Model?.TrangThai
                </span>

                @if (Model?.TrangThai == "Đã đặt hàng")
                {
                    <button class="btn btn-sm btn-outline-danger ms-2" data-bs-toggle="modal"
                            data-bs-target="#confirmHuyModal" data-id="@Model.MaDonHang">
                        Hủy đơn
                    </button>
                }
                else if (Model?.TrangThai == "Đang giao hàng")
                {
                    <button class="btn btn-sm btn-outline-success ms-2" data-bs-toggle="modal"
                            data-bs-target="#confirmNhanModal" data-id="@Model.MaDonHang">
                        Nhận hàng
                    </button>
                }
            </div>
        </div>

    </div>
</div>

<!-- Danh sách sản phẩm -->
<h4 class="fw-bold text-primary mb-3">Danh sách sản phẩm</h4>

@if (Model?.ChiTietDonHangs != null && Model.ChiTietDonHangs.Any())
{
    <table class="table table-striped table-hover shadow-sm align-middle" style="border-radius:12px; overflow:hidden;">
        <thead class="bg-primary text-white">
            <tr>
                <th class="text-center">#</th>
                <th>Tên sách</th>
                <th class="text-center">Số lượng</th>
                <th class="text-end">Đơn giá</th>
                <th class="text-end">Thành tiền</th>
            </tr>
        </thead>

        <tbody>
            @{
                int stt = 1;
                decimal tongTien = 0;
            }

            @foreach (var ct in Model.ChiTietDonHangs)
            {
                var gia = ct?.Sach?.Gia ?? 0;
                var soLuong = ct?.SoLuong ?? 0;
                var tenSach = ct?.Sach?.TenSach ?? "Chưa có tên";
                var thanhTien = gia * soLuong;

                <tr>
                    <td class="text-center">@stt</td>
                    <td>@tenSach</td>
                    <td class="text-center">@soLuong</td>
                    <td class="text-end">@gia.ToString("N0") VNĐ</td>
                    <td class="text-end text-danger fw-semibold">@thanhTien.ToString("N0") VNĐ</td>
                </tr>

                tongTien += thanhTien;
                stt++;
            }
        </tbody>

        <tfoot class="bg-light">
            <tr>
                <th colspan="4" class="text-end fw-bold">Tổng tiền:</th>
                <th class="text-end text-danger fw-bold">@tongTien.ToString("N0") VNĐ</th>
            </tr>
        </tfoot>
    </table>

    <a asp-controller="DonHang" asp-action="Index" class="btn btn-secondary mt-3">
        ← Quay lại danh sách đơn hàng
    </a>
}
else
{
    <p class="text-warning">Không có sản phẩm nào trong đơn hàng.</p>
}

<!-- Modal Hủy đơn -->
<div class="modal fade" id="confirmHuyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <form method="post" asp-action="HuyHang" asp-controller="DonHang">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title text-danger fw-bold">Xác nhận hủy đơn hàng</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    Bạn có chắc chắn muốn hủy đơn này không?
                    <input type="hidden" name="MaDonHang" id="huyDonId" />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                    <button type="submit" class="btn btn-danger">Hủy đơn</button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- Modal Nhận hàng -->
<div class="modal fade" id="confirmNhanModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <form method="post" asp-action="NhanHang" asp-controller="DonHang">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title text-success fw-bold">Xác nhận nhận hàng</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    Bạn đã nhận được hàng chứ?
                    <input type="hidden" name="MaDonHang" id="nhanDonId" />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                    <button type="submit" class="btn btn-success">Đã nhận</button>
                </div>

            </form>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Xử lý gán mã đơn cho modal hủy
        var huyModal = document.getElementById('confirmHuyModal');
        huyModal.addEventListener('show.bs.modal', function (event) {
            document.getElementById('huyDonId').value = event.relatedTarget.getAttribute('data-id');
        });

        // Xử lý gán mã đơn cho modal nhận
        var nhanModal = document.getElementById('confirmNhanModal');
        nhanModal.addEventListener('show.bs.modal', function (event) {
            document.getElementById('nhanDonId').value = event.relatedTarget.getAttribute('data-id');
        });
    </script>
}
