@model IEnumerable<QLBanSach.Models.ChiTietGioHang>
@{
    ViewData["Title"] = "Giỏ hàng";
    var gioHang = ViewBag.GioHang as QLBanSach.Models.GioHang;
}

<link href="~/css/GioHang.css" rel="stylesheet" />
<h2 class="mb-3">Giỏ hàng của bạn</h2>

@if (gioHang != null)
{
    <div class="mb-3">
        <p><strong>Mã giỏ hàng:</strong> @gioHang.MaGioHang</p>
        <p><strong>Ngày tạo:</strong> @gioHang.NgayTao.ToString("dd/MM/yyyy")</p>
    </div>
}

<hr />

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info text-center">
        Giỏ hàng hiện đang trống.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Ảnh</th>
                    <th>Tên sách</th>
                    <th>Giá</th>
                    <th>Số lượng</th>
                    <th>Tổng tiền</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Select((value, index) => new { value, index }))
                {
                    <tr data-id="@item.value.MaChiTiet">
                        <td>@(item.index + 1)</td>
                        <td>
                            @if(!string.IsNullOrEmpty(item.value.Sach?.Anh))
                            {
                                <img src="~/Images/@item.value.Sach.Anh" alt="@item.value.Sach.TenSach" class="img-thumbnail" style="width:60px; height:auto;" />
                            }
                        </td>
                        <td>@item.value.Sach?.TenSach</td>
                        <td class="gia" data-gia="@item.value.Sach.Gia">
                            @(item.value.Sach != null ? item.value.Sach.Gia.ToString("N0") + " VNĐ" : "-")
                        </td>
                        <td>
                            <div class="input-group" style="width:110px;">
                                <button type="button" class="btn btn-outline-secondary btn-sm btn-minus">-</button>
                                <input type="Text" min="1" class="form-control text-center so-luong" value="@item.value.SoLuong" />
                                <button type="button" class="btn btn-outline-secondary btn-sm btn-plus">+</button>
                            </div>
                        </td>
                        <td class="tong-tien">
                            @(item.value.Sach != null ? (item.value.SoLuong * item.value.Sach.Gia).ToString("N0") + " VNĐ" : "-")
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger btn-remove" data-id="@item.value.MaChiTiet">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between mt-3">
        <a class="btn btn-secondary" asp-action="Index" asp-controller="Home">Tiếp tục mua sắm</a>
        <a class="btn btn-primary" asp-action="DatHang" asp-controller="DonHang" asp-route-maGioHang="@gioHang.MaGioHang">
            Đặt Đơn Hàng
        </a>
    </div>

    <div class="mt-3 text-end">
        <strong>Tổng cộng: </strong> <span id="tong-cong"></span>
    </div>
}

@section Scripts {
<script>
function formatVND(number) {
    return number.toLocaleString('vi-VN') + ' VNĐ';
}

function updateTongTienRow(row) {
    const gia = parseInt(row.querySelector('.gia').dataset.gia);
    const sl = parseInt(row.querySelector('.so-luong').value);
    row.querySelector('.tong-tien').innerText = formatVND(gia * sl);
    updateTongCong();
}

function updateTongCong() {
    let tong = 0;
    document.querySelectorAll('tbody tr').forEach(row => {
        const gia = parseInt(row.querySelector('.gia').dataset.gia);
        const sl = parseInt(row.querySelector('.so-luong').value);
        tong += gia * sl;
    });
    document.getElementById('tong-cong').innerText = formatVND(tong);
}

function capNhatSoLuongServer(maChiTiet, soLuong) {
    fetch('@Url.Action("UpdateSoLuong","GioHang")', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: `maChiTiet=${maChiTiet}&soLuong=${soLuong}&__RequestVerificationToken=${$('input[name="__RequestVerificationToken"]').val()}`
    })
    .then(res => res.json())
    .then(data => {
        if(!data.success) alert("Cập nhật số lượng thất bại!");
    });
}

document.querySelectorAll('.so-luong').forEach(input => {
    input.addEventListener('change', e => {
        let sl = parseInt(e.target.value);
        if(sl < 1) sl = 1;
        e.target.value = sl;
        const row = e.target.closest('tr');
        const maChiTiet = row.dataset.id;
        updateTongTienRow(row);
        capNhatSoLuongServer(maChiTiet, sl);
    });
});

document.querySelectorAll('.btn-plus').forEach(btn => {
    btn.addEventListener('click', e => {
        const input = e.target.closest('td').querySelector('.so-luong');
        input.value = parseInt(input.value) + 1;
        const row = e.target.closest('tr');
        const maChiTiet = row.dataset.id;
        updateTongTienRow(row);
        capNhatSoLuongServer(maChiTiet, parseInt(input.value));
    });
});

document.querySelectorAll('.btn-minus').forEach(btn => {
    btn.addEventListener('click', e => {
        const input = e.target.closest('td').querySelector('.so-luong');
        if(parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
            const row = e.target.closest('tr');
            const maChiTiet = row.dataset.id;
            updateTongTienRow(row);
            capNhatSoLuongServer(maChiTiet, parseInt(input.value));
        }
    });
});
updateTongCong();

document.querySelectorAll('.btn-remove').forEach(btn => {
    btn.addEventListener('click', e => {
        const maChiTiet = btn.dataset.id;
        if(!confirm("Bạn có chắc muốn xóa sản phẩm này?")) return;

        fetch('@Url.Action("RemoveChiTiet","GioHang")', {
            method: 'POST',
            headers: {
                'Content-Type':'application/x-www-form-urlencoded'
            },
            body: `maChiTiet=${maChiTiet}&__RequestVerificationToken=${$('input[name="__RequestVerificationToken"]').val()}`
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const row = btn.closest('tr');
                row.remove();
                updateTongCong();
            } else {
                alert("Xóa thất bại!");
            }
        });
    });
});
</script>
}